# 魔兽世界实战



## 分析护甲值

ce搜索到护甲值

什么访问了这个内存

```
004F54D8 - 53 - push ebx
004F54D9 - 56 - push esi
004F54DA - 8B B4 90 74010000  - mov esi,[eax+edx*4+00000174] <<
004F54E1 - 8B 45 10  - mov eax,[ebp+10]
004F54E4 - 57 - push edi

EAX=358B53A0
EBX=00000000
ECX=358B3B00
EDX=00000000
ESI=0000003C
EDI=1EEBF360
ESP=049FF608
EBP=049FF610
EIP=004F54E1
```

得知内存地址 = [eax+edx*4+00000174]

记当前内存的地址004F54DA

将程序附加到xdbg调试查看这块内存上的汇编
```
004F54D0                 | 55                       | push ebp                                              |
004F54D1                 | 8BEC                     | mov ebp,esp                                           |
004F54D3                 | 8B01                     | mov eax,dword ptr ds:[ecx]                            |
004F54D5                 | 8B55 08                  | mov edx,dword ptr ss:[ebp+8]                          |
004F54D8                 | 53                       | push ebx                                              |
004F54D9                 | 56                       | push esi                                              |
004F54DA                 | 8BB490 74010000          | mov esi,dword ptr ds:[eax+edx*4+174]                  |
```

eax = [ecx] = 34A86980

在下断点后，打开背包会断住，此时ecx是34A850E0

eax = [34A850E0]
故 内存地址 = [ecx]+0+174

ce中寻找ecx的值，函数中没有ecx的值出现，通过堆栈返回上层函数查找ecx的值
![image-20220716123638194](C:\Users\ROOT\AppData\Roaming\Typora\typora-user-images\image-20220716123638194.png)

ecx = esi+D0

内存地址[esi+D0]+0+174

寻找esi来源
![image-20220716123828085](C:\Users\ROOT\AppData\Roaming\Typora\typora-user-images\image-20220716123828085.png)

向上查找，得到esi = eax
call的返回值储存在eax里，则eax可能是call wow.60c1f0的返回值，则只要手动调用函数，获取里面的eax即可得到数值

手动调用函数需要明确参数个数

进入60c1f0函数，查看
![image-20220716124747095](C:\Users\ROOT\AppData\Roaming\Typora\typora-user-images\image-20220716124747095.png)

ret没有带参数，说明是外平栈，函数外部也没有进行平栈，可能是多个函数的栈一起平，暂时无法确认参数个数
![image-20220716124941499](C:\Users\ROOT\AppData\Roaming\Typora\typora-user-images\image-20220716124941499.png)
整个函数就出现了一个栈空间里的变量，所以猜测只传入了一个参数
注:一般来说ebp+8位第一个参数，ebp+c为第二个参数

返回上层函数

![image-20220716125259228](C:\Users\ROOT\AppData\Roaming\Typora\typora-user-images\image-20220716125259228.png) 

在调用60C1F0前，只push了一个参数，猜测是只传入一个参数，参数是eax
xdbg识别出来是字符串player
![image-20220716125545547](C:\Users\ROOT\AppData\Roaming\Typora\typora-user-images\image-20220716125545547.png)



则思路为：汇编传入一个“player”参数，call 60C1F0函数，复制eax值，平栈，则[eax+D0]+174就是护甲值，则基址就是eax。将写好的dll文件注入，即可

## 分析人物有关其他数据

其他数据：一般所有同一人物数据都是储存在一个对象中的，所以顺着护甲的数据可以找到其他数据

![image-20220717233945276](C:\Users\ROOT\AppData\Roaming\Typora\typora-user-images\image-20220717233945276.png) 

51为护甲值，上面德邦19,17,21分别是其他几个属性
[eax+0xD0]+138 = 力量
[eax+0xD0]+13C = 敏捷 
[eax+0xD0]+140 = 耐力 
[eax+0xD0]+144 = 智力  
[eax+0xD0]+148 = 精神 

```
代码：
C++文件代码：
#include <iostream>
#include<Windows.h>
int main()
{
	const char *DllPath = "C:\\Users\\ROOT\\source\\repos\\MFCLibrary\\Release\\MFCLibrary.dll";
	const char *WinName = "魔兽世界";
	DWORD PID=0;
	UINT_PTR AllocAddress=NULL;
	HWND Window = FindWindowA("GxWindowClassD3d", "魔兽世界");
	GetWindowThreadProcessId(Window, &PID);
	HANDLE hProcess = OpenProcess(PROCESS_ALL_ACCESS, FALSE, PID);
	if (hProcess == NULL)
		MessageBoxA(NULL, "1", "1",MB_OK);
	AllocAddress = (UINT_PTR)VirtualAllocEx(hProcess,0, 4 * 1024, MEM_COMMIT, PAGE_EXECUTE_READWRITE);
	WriteProcessMemory(hProcess, (LPVOID)AllocAddress, DllPath, 0x300, NULL);
	CreateRemoteThread(hProcess, NULL, NULL, (LPTHREAD_START_ROUTINE)LoadLibraryA, (LPVOID)AllocAddress, 0, NULL);
	getchar();
}

DLL文件代码：
VOID CALLBACK timer(HWND h, UINT i, UINT_PTR n, DWORD d)
{
	DWORD RM(UINT_PTR address);
	const char*param1 = "player";
	UINT_PTR a;
	UINT_PTR address = 0x60C1F0;
	KillTimer(h, 1);
	char buff[100];
	__asm
	{
		push param1
		call address
		add ebp, 4
		mov a, eax
	}
	printf("力量=%d\n敏捷=%d\n耐力=%d\n智力=%d\n精神=%d\n护甲值=%d\n",
		RM(RM(a + 0x000000D0) + 0x00000138),
		RM(RM(a + 0x000000D0) + 0x0000013C),
		RM(RM(a + 0x000000D0) + 0x00000140),
		RM(RM(a + 0x000000D0) + 0x00000144),
		RM(RM(a + 0x000000D0) + 0x00000148),
		RM(RM(a + 0x000000D0) + 0x00000174)
	);
	
}
;
DWORD RM(UINT_PTR address)
{
	return *((DWORD*)address);
}
void DLL::OnBnClickedButton1()
{
	 //TODO: 在此添加控件通知处理程序代码
	HWND hProcess = FindWindowA(NULL, "魔兽世界");

	::SetTimer(hProcess,1,1,timer);
}


void DLL::OnBnClickedButton2()
{
	// TODO: 在此添加控件通知处理程序代码
	AllocConsole();
	FILE *pFile=NULL;
	errno_t iret = freopen_s(&pFile,"CONOUT$", "w", stdout);
}

修改DLL文件代码：
BOOL CMFCLibraryApp::InitInstance()
{
	CWinApp::InitInstance();
	::CreateThread(NULL, NULL, (LPTHREAD_START_ROUTINE)THEC, NULL, NULL, NULL);
	return TRUE;
}

DWORD WINAPI THEC()
{
	AFX_MANAGE_STATE(AfxGetStaticModuleState());
	DLL dll;
	dll.DoModal();
	return TRUE;
}
```

ce搜索人物的名字，获取人物姓名基址

完善代码(char *)0xC79D18为名称基址



## 分析怪物名称（已失败）

搜索怪物的名字，依次修改，看游戏数据是否改变找到地址（12B070B8）为当前选中怪物的名字

在xdbg中打开函数地址，查看内存段
```
12B070B8  凶猛的树人嫩苗1
```

在此处下硬件断点，鼠标移到怪物身上，直接断下，看周围汇编代码
```
0076ED20                     | push ebp                                              |
0076ED21                     | mov ebp,esp                                           |
0076ED23                     | push esi                                              |
0076ED24                     | mov esi,dword ptr ss:[ebp+8]                          |
0076ED27                     | test esi,esi                                          |
0076ED29                     | je wow.76ED32                                         |
0076ED2B                     | mov edx,dword ptr ss:[ebp+C]                          |
0076ED2E                     | test edx,edx                                          |
0076ED30                     | jne wow.76ED40                                        |
0076ED32                     | push 57                                               |
0076ED34                     | call wow.771870                                       |
0076ED39                     | xor eax,eax                                           |
0076ED3B                     | pop esi                                               |
0076ED3C                     | pop ebp                                               |
0076ED3D                     | ret C                                                 |
0076ED40                     | mov eax,dword ptr ss:[ebp+10]                         |
0076ED43                     | cmp eax,7FFFFFFF                                      |
0076ED48                     | push edi                                              |
0076ED49                     | je wow.76ED75                                         |
0076ED4B                     | cmp byte ptr ds:[edx],0                               |
0076ED4E                     | lea edi,dword ptr ds:[esi+eax-1]                      |此处断下 eip->
```

此时edx = 12B070B8，正是怪物名字的地址
向上查找
edx = \*(ebp+C)
[edx]为值

所以
值 =* (\*(ebp+c))
由于ebp+c为第二个参数，返回上层call，查看push的值

```
00819F0D                     | mov dword ptr ds:[D413A0],edi                         | edi:&"`疧"
00819F13                     | call wow.84DAB0                                       |
00819F18                     | mov edi,dword ptr ss:[ebp+C]                          | [ebp+C]:&"`疧"
00819F1B                     | add esp,8                                             |
00819F1E                     | test edi,edi                                          | edi:&"`疧"
00819F20                     | je wow.819FD0                                         |
00819F26                     | mov edx,dword ptr ds:[edi]                            | edx:"`疧", [edi]:"`疧"
00819F28                     | mov eax,dword ptr ds:[edx+4]                          |
00819F2B                     | mov ecx,edi                                           | ecx:"WorldFrame", edi:&"`疧"
00819F2D                     | call eax                                              |
00819F2F                     | test eax,eax                                          |
00819F31                     | mov dword ptr ss:[ebp-4],eax                          | [ebp-4]:"WorldFrame"
00819F34                     | jne wow.819F3D                                        |
00819F36                     | mov dword ptr ss:[ebp-4],wow.9EA280                   | [ebp-4]:"WorldFrame", 9EA280:"<unnamed>"
00819F3D                     | mov ecx,dword ptr ss:[ebp-4]                          | [ebp-4]:"WorldFrame"
00819F40                     | push ecx                                              | ecx:"WorldFrame"
00819F41                     | call wow.76EE30                                       |
00819F46                     | add eax,5                                             |
00819F49                     | call wow.40CA10                                       |
00819F4E                     | mov eax,esp                                           |
00819F50                     | push 7FFFFFFF                                         |
00819F55                     | push wow.A44FCC                                       | A44FCC:"DBG:"
00819F5A                     | push eax                                              |
00819F5B                     | mov dword ptr ss:[ebp-14],eax                         |
00819F5E                     | call wow.76ED20                                       |
```

第二个参数为wow.A44FCC，是一个函数，把函数的地址传进去
\*(\*([&wow.A44FCC]+c))

至此，失败，人麻了

## 分析人物选中的怪物的名字

先让人物对怪物进入选中状态，ce中搜索怪物名字，修改怪物的名字，看在游戏中的表现，如果游戏中怪物的名字一起发生改变，则是正确数据，记录怪物名字的地址，在xdbg内存栏中搜索，下硬件断点，看代码段，分析基址
此时根据名字下的断点停在了此处

```
0053B8E0                     | push ebp                                              |
0053B8E1                     | mov ebp,esp                                           |
0053B8E3                     | mov eax,dword ptr ss:[ebp+8]                          |[ebp+8] = 0
0053B8E6                     | mov eax,dword ptr ds:[ecx+eax*4+5C]                   | eax = [ecx+eax*4+5C]  [ecx+eax*4+5c],eax=0 ,故 eax = [ecx+5C]
0053B8EA                     | test eax,eax                                          | and运算
0053B8EC                     | je wow.53B8F3                                         |
0053B8EE                     | cmp byte ptr ds:[eax],0                               | [eax] = 选中的怪物的名字
```

根据代码，可知  选中的怪物的名字 = [[ecx+5C]] ，需向上追查ecx的值
下断点在函数的开头，根据占空间的值向上查上一层call

上一层call代码
```
0074F842                     | push eax                                              |
0074F843                     | push ecx                                              |
0074F844                     | push edx                                              |
0074F845                     | mov ecx,wow.C5D690                                    | C5D690:&"鸫g"
0074F84A                     | call wow.67B6A0                                       | eax 为此函数的返回值
0074F84F                     | test eax,eax                                          |
0074F851                     | je wow.74F8C2                                         |
0074F853                     | push 0                                                |
0074F855                     | mov ecx,eax                                           | ecx = eax
0074F857                     | call wow.53B8E0                                       | 获取选中的怪物名称的call
```

由此可知，ecx = eax，eax则为函数的返回值，为wow.67B6A0函数的返回值，跟进wow.67B6A0函数，步进观察eax值的变化，查看具体是在哪里得到返回值

进入函数
```
0067B69F                     | int3                                                  |
0067B6A0                     | push ebp                                              |
0067B6A1                     | mov ebp,esp                                           |
0067B6A3                     | push ebx                                              |
0067B6A4                     | push edi                                              |
0067B6A5                     | mov edi,dword ptr ss:[ebp+8]                          | [ebp+8]:"`弓"
0067B6A8                     | test edi,edi                                          |
0067B6AA                     | mov ebx,ecx                                           | ecx:&"鸫g"
0067B6AC                     | jne wow.67B6B6                                        |
0067B6AE                     | pop edi                                               |
0067B6AF                     | xor eax,eax                                           |
0067B6B1                     | pop ebx                                               |
0067B6B2                     | pop ebp                                               |
0067B6B3                     | ret 14                                                |
0067B6B6                     | push esi                                              | esi:"`弓"
0067B6B7                     | lea eax,dword ptr ss:[ebp+1B]                         |
0067B6BA                     | push eax                                              |
0067B6BB                     | lea esi,dword ptr ds:[ebx+8]                          | esi:"`弓"
0067B6BE                     | push edi                                              |
0067B6BF                     | mov ecx,esi                                           |
0067B6C1                     | call wow.6F6020                        | 得到eax，此时还需要+18才是正确的eax
.
. 不知道多少行后
.
0067B834                     | add eax,18                                            | eax = eax+18
```

eax是函数wow.6F6020的返回值，此时的eax还需要再+18，再跟进6F6020函数，看具体是在哪里返回的,进入函数
```
006F6020                     | push ebp                                              |
006F6021                     | mov ebp,esp                                           |
006F6023                     | mov eax,dword ptr ds:[ecx+24]                         |
006F6026                     | cmp eax,FFFFFFFF                                      |
006F6029                     | jne wow.6F6031                                        |
006F602B                     | xor eax,eax                                           |
006F602D                     | pop ebp                                               |
006F602E                     | ret 8                                                 |
006F6031                     | mov edx,dword ptr ds:[ecx+1C]                         |
006F6034                     | push esi                                              |
006F6035                     | mov esi,dword ptr ss:[ebp+8]                          |
006F6038                     | and eax,esi                                           |
006F603A                     | lea eax,dword ptr ds:[eax+eax*2]                      |
006F603D                     | lea eax,dword ptr ds:[edx+eax*4+4]                    |
006F6041                     | mov eax,dword ptr ds:[eax+4]                          |
006F6044                     | test al,1                                             |
006F6046                     | jne wow.6F604C                                        |
006F6048                     | test eax,eax                                          |
006F604A                     | jne wow.6F604E                                        |
006F604C                     | xor eax,eax                                           |
006F604E                     | push edi                                              |
006F604F                     | nop                                                   |
006F6050                     | test al,1                                             |
006F6052                     | jne wow.6F6073                                        |
006F6054                     | test eax,eax                                          |
006F6056                     | je wow.6F6073                                         |
006F6058                     | cmp dword ptr ds:[eax],esi                            |
006F605A                     | je wow.6F6075                                         |
006F605C                     | mov edi,dword ptr ds:[ecx+1C]                         |
006F605F                     | mov edx,esi                                           |
006F6061                     | and edx,dword ptr ds:[ecx+24]                         |
006F6064                     | lea edx,dword ptr ds:[edx+edx*2]                      |
006F6067                     | lea edx,dword ptr ds:[edi+edx*4]                      |
006F606A                     | mov edx,dword ptr ds:[edx]                            |
006F606C                     | add edx,eax                                           |
006F606E                     | mov eax,dword ptr ds:[edx+4]                          | 
006F6071                     | jmp wow.6F6050                                        |
006F6073                     | xor eax,eax                                           |
006F6075                     | pop edi                                               |
006F6076                     | pop esi                                               |
006F6077                     | pop ebp                                               |
006F6078                     | ret 8                                                 |
```

阶段性总结 ：选中的怪物的名字 = \[\[wow.6F6020函数的返回值(eax)+18+5C\]\]

至此，追不下去，得不到怪物对象，换一种方法追

## 分析人物选中的怪物的名字（方法二）

ce搜索出选定的对象，搜索找到对象名称的地址的地址，查看什么访问了此内存，查看反汇编
```
wow.exe.text+329275 - 8B B6 64090000        - mov esi,[esi+00000964]
wow.exe.text+32927B - 85 F6                 - test esi,esi
wow.exe.text+32927D - 74 CE                 - je wow.exe.text+32924D
wow.exe.text+32927F - 8B 46 5C              - mov eax,[esi+5C]
```

eax为对象名称的地址的地址，有两层偏移，[esi+5C]和[esi+00000964]
故：eax = [[esi+00000964]+5c]，进xdbg调试
在- mov esi,[esi+00000964]处下断点，查看esi的值
40C722A8  00A34D90
在追一层

```
00A34D90  00737BA0   {s.  
00A34D94  00734FD0  ÐOs.  
00A34D98  007237F0  ð7r.  
00A34D9C  007402B0  °.t.  
00A34DA0  00632050  P c.  
00A34DA4  007370D0  Ðps.  
00A34DA8  00714C40  @Lq.  
00A34DAC  0073E410  .äs.  
```

跟进以后，每一个内存跟进去都是函数，标准的push，说明esi（40C722A8）是虚函数指针，因此esi很有可能是对象，而此时选中的是怪物，则合理猜测是怪物对象（md，怪物对象我是猜不出来，那吊课说的）
故   人物选中的怪物的名字 = \[\[怪物对象+964\]+5C\]

## 分析怪物对象

课程经验：一般人物对象、怪物对象、地面掉落物对象，都是储存在同一个对象数组里的，所以可以通过人物对象来分析怪物，不直接用怪物对象，是因为找到的怪物对象不方便分析，相比之下，找到的人物对象更适合分析
```
找到查询人物对象的call
00610EFB    | push eax                             |
00610EFC    | call wow.60C1F0                      | 获取人物对象
00610F01    | mov esi,eax                          |
00610F03    | add esp,10                           |
00610F06    | cmp esi,ebx                          |
00610F08    | mov dword ptr ss:[ebp-C],ebx         |
00610F0B    | mov dword ptr ss:[ebp-8],ebx         |
00610F0E    | mov dword ptr ss:[ebp-10],ebx        |
00610F11    | mov dword ptr ss:[ebp-14],ebx        |
00610F14    | mov dword ptr ss:[ebp-4],ebx         |
00610F17    | je wow.610F4C                        |
00610F19    | mov eax,dword ptr ds:[esi+8]         |
00610F1C    | mov ecx,dword ptr ds:[eax+8]         |
00610F1F    | shr ecx,3                            |
00610F22    | test cl,1                            |
00610F25    | je wow.610F4C                        |
00610F27    | lea edx,dword ptr ss:[ebp-14]        |
00610F2A    | push edx                             |
00610F2B    | lea eax,dword ptr ss:[ebp-10]        |
00610F2E    | push eax                             |
00610F2F    | lea ecx,dword ptr ss:[ebp-8]         |
00610F32    | push ecx                             |
00610F33    | lea edx,dword ptr ss:[ebp-C]         |
00610F36    | push edx                             |
00610F37    | lea eax,dword ptr ss:[ebp-4]         |
00610F3A    | push eax                             |
00610F3B    | call wow.6337A0                      |
00610F40    | push eax                             |
00610F41    | lea ecx,dword ptr ds:[esi+D0]        |
00610F47    | call wow.4F54D0                      | 拿着eax查人物属性
```

进入call 60C1F0，看什么时候返回正确的值,在
```
0060C1F0    | push ebp                             |
0060C1F1    | mov ebp,esp                          |
0060C1F3    | mov ecx,dword ptr ss:[ebp+8]         |
0060C1F6    | sub esp,8                            |
0060C1F9    | push esi                             |
0060C1FA    | xor esi,esi                          |
0060C1FC    | push esi                             |
0060C1FD    | lea eax,dword ptr ss:[ebp-8]         |
0060C200    | push eax                             | eax:"player"
0060C201    | push ecx                             |
0060C202    | call wow.60ABF0                      |
0060C207    | add esp,C                            |
0060C20A    | test al,al                           |
0060C20C    | je wow.60C22F                        |
0060C20E    | mov edx,dword ptr ss:[ebp-4]         |
0060C211    | mov eax,dword ptr ss:[ebp-8]         |
0060C214    | push 148                             |
0060C219    | push wow.A22CD4                      | A22CD4:".\\ScriptEvents.cpp"
0060C21E    | push 8                               |
0060C220    | push edx                             | edx:"X9$#!鐓"
0060C221    | push eax                             | eax:"player"
0060C222    | call wow.4D4DB0                      | [eax+D0]+174==护甲，是人物对象
0060C227    | add esp,14                           |
0060C22A    | pop esi                              |
0060C22B    | mov esp,ebp                          |
0060C22D    | pop ebp                              |
0060C22E    | ret                                  |
0060C22F    | mov eax,esi                          | eax:"player"
0060C231    | pop esi                              |
0060C232    | mov esp,ebp                          |
0060C234    | pop ebp                              |
0060C235    | ret                                  |
```

在60C1F0函数上下断点，而不是4D4DB0函数上下断点，以保证查询的是自己的对象，而不是每次查怪物、npc对象的时候也停下来，根据eax的值来判断在哪里得到
进入4D4BB0

```
004D4BB0    | push ebp                             |
004D4BB1    | mov ebp,esp                          |
004D4BB3    | mov eax,dword ptr ds:[ecx+24]        | eax:&"衳n"
004D4BB6    | cmp eax,FFFFFFFF                     | eax:&"衳n"
004D4BB9    | jne wow.4D4BC1                       |
004D4BBB    | xor eax,eax                          | eax:&"衳n"
004D4BBD    | pop ebp                              |
004D4BBE    | ret 8                                |
004D4BC1    | mov edx,dword ptr ds:[ecx+1C]        |
004D4BC4    | push esi                             |
004D4BC5    | mov esi,dword ptr ss:[ebp+8]         |
004D4BC8    | and eax,esi                          | eax:&"衳n"
004D4BCA    | lea eax,dword ptr ds:[eax+eax*2]     | eax:&"衳n"
004D4BCD    | lea eax,dword ptr ds:[edx+eax*4+4]   | eax:&"衳n"
004D4BD1    | mov eax,dword ptr ds:[eax+4]         | 正确的eax出现，即人物对象出现
004D4BD4    | test al,1                            |
```

找到正确的eax，eax经验证为虚函数指针，eax极大可能为对象，并且不单单是查询人物对象的时候会断下，所以很有可能其他怪物对象也在这里返回，开始向上追基址
```
4D4BB0函数
004D4BB0    | push ebp                             |
004D4BB1    | mov ebp,esp                          |
004D4BB3    | mov eax,dword ptr ds:[ecx+24]        | eax = [ecx+24]
004D4BB6    | cmp eax,FFFFFFFF                     |
004D4BB9    | jne wow.4D4BC1                       |
004D4BBB    | xor eax,eax                          |
004D4BBD    | pop ebp                              |
004D4BBE    | ret 8                                |
004D4BC1    | mov edx,dword ptr ds:[ecx+1C]        | edx = [ecx+1c]
004D4BC4    | push esi                             |
004D4BC5    | mov esi,dword ptr ss:[ebp+8]         |
004D4BC8    | and eax,esi                          |
004D4BCA    | lea eax,dword ptr ds:[eax+eax*2]     | eax = eax*3
004D4BCD    | lea eax,dword ptr ds:[edx+eax*4+4]   | eax = edx+eax*4+4 = edx+eax*3*4+4 = [ecx+1c]+[ecx+24]*3*4+4
004D4BD1    | mov eax,dword ptr ds:[eax+4]         | 正确的eax出现，即人物对象出现 ,eax = [eax+4] = [edx+eax*4+4+4] = [edx+eax*12+8] = [[ecx+1c]+[ecx+24]*3*4+4+4]
```

当层函数得知 eax  = [[ecx+1c]+[ecx+24]*3*4+4+4],向上层追ecx的值
```
004D4DB0    | push ebp                             |
004D4DB1    | mov ebp,esp                          |
004D4DB3    | mov ecx,dword ptr fs:[2C]            | ecx = Fs:[2C]
004D4DBA    | mov eax,dword ptr ds:[D439BC]        | eax = [D439BC]
004D4DBF    | mov edx,dword ptr ds:[ecx+eax*4]     | edx = [ecx+eax*4] = [ecx+[D439BC]*4]
004D4DC2    | mov ecx,dword ptr ds:[edx+8]         | ecx = [edx+8] = [[ecx+eax*4]+8] = [[ecx+[D439BC]*4]+8] = [[fs:[2c]+[D439BC]*4]+8]
004D4DC8    | sub esp,8                            |
004D4DCB    | test ecx,ecx                         |
004D4DCD    | je wow.4D4DFC                        |
004D4DCF    | mov eax,dword ptr ss:[ebp+8]         |
004D4DD2    | mov edx,dword ptr ss:[ebp+C]         |
004D4DD5    | push esi                             |
004D4DD6    | mov esi,eax                          |
004D4DD8    | or esi,edx                           |
004D4DDA    | pop esi                              |
004D4DDB    | je wow.4D4DFC                        |
004D4DDD    | mov dword ptr ss:[ebp-4],edx         |
004D4DE0    | lea edx,dword ptr ss:[ebp-8]         | [ebp-8]:&"衳n"
004D4DE3    | push edx                             |
004D4DE4    | push eax                             |
004D4DE5    | mov dword ptr ss:[ebp-8],eax         | [ebp-8]:&"衳n"
004D4DE8    | call wow.4D4BB0                      | 这里返回eax
```

```
分析call，得到ecx = [[[fs:[2c]]+[D439BC]*4]+8]
结合eax  = [[ecx+1c]+[ecx+24]*3*4+4+4]
但是在004D4BC8    | and eax,esi    处
出现了一个截断，这个截断会直接改变eax的值，截断的来源是传入的第一个参数
所以修改eax的来源为eax = [[ecx+1c]+参数1*0c+8]
当参数1为8的时候查询人物对象
其他参数有待确定
得到 eax = [[[[fs:[2c]+[D439BC]*4]+8]+1c]+参数1*0c+8]
验证：
[[[[[fs:[2c]+[D439BC]*4]+8]+1c]+8*0c+8]+D0]+174 可以得到护甲值
[[[[[[fs:[2c]+[D439BC]*4]+8]+1c]+0*0c+8]+964]+5C] 可以得到怪物名字
可以修改参数1的值以获得不同的对象
```

## 分析技能快捷栏使用call

在快捷栏处分出一个空位
![image-20220808163907674](C:\Users\ROOT\AppData\Roaming\Typora\typora-user-images\image-20220808163907674.png)

当有技能填在上面的时候，数值大于0，当没技能填在上面的时候，数值小于0，当上面的技能发生变化的时候，值会跟着变化，当不去改变那个空位上的技能时，值不变，ce过滤出一个值
![image-20220808164041461](C:\Users\ROOT\AppData\Roaming\Typora\typora-user-images\image-20220808164041461.png)
![image-20220808164118356](C:\Users\ROOT\AppData\Roaming\Typora\typora-user-images\image-20220808164118356.png)

查看什么访问了此内存，点击释放技能，可以看到点击了一次后，有三个指令只执行了一次
![image-20220808165144876](C:\Users\ROOT\AppData\Roaming\Typora\typora-user-images\image-20220808165144876.png)

简单分析发现，其访问了一个[esi*4+wow.exe+81E358]的值，此时esi=0，对应了技能栏的第0位，因此esi有可能是数组的下标，81E358为数组的首地址，此数组为技能栏数组。
验证：添加一个地址[1\*esi+wow.exe+81E358],改变技能栏的第1位技能，看数据变化

```
###
wow.exe.text+1AAC3B:
005ABC39 - C3 - ret 
005ABC3A - 53 - push ebx
005ABC3B - 8B 1C B5 58E3C100  - mov ebx,[esi*4+wow.exe+81E358] <<
005ABC42 - 3B DF  - cmp ebx,edi
005ABC44 - 0F84 12020000 - je wow.exe+1ABE5C
###
wow.exe.text+1A6896:
005A7891 - 8B EC  - mov ebp,esp
005A7893 - 8B 45 08  - mov eax,[ebp+08]
005A7896 - 8B 04 85 58E3C100  - mov eax,[eax*4+wow.exe+81E358] <<
005A789D - 85 C0  - test eax,eax
005A789F - 74 13 - je wow.exe+1A78B4
###
wow.exe.text+1A68F6:
005A78F1 - 8B EC  - mov ebp,esp
005A78F3 - 8B 45 08  - mov eax,[ebp+08]
005A78F6 - 8B 04 85 58E3C100  - mov eax,[eax*4+wow.exe+81E358] <<
005A78FD - 85 C0  - test eax,eax
005A78FF - 74 13 - je wow.exe+1A7914
```

进入xdbg，依次下断点调试，进入第一个函数005ABC3A，下断点后点击技能释放，游戏界面卡主，说明是调用技能释放的call
```
005ABC3A    | push ebx                             |
005ABC3B    | mov ebx,dword ptr ds:[esi*4+C1E358]  |
005ABC42    | cmp ebx,edi                          |
005ABC44    | je wow.5ABE5C                        |
005ABC4A    | push esi                             |
分析发现此时esi为0，返回上一层call
```

上一层call
```
005AC059    | push eax                             | eax:"LeftButton"
005AC05A    | lea ecx,dword ptr ss:[ebp-8]         |
005AC05D    | push ecx                             |
005AC05E    | push esi                             | 传入了三个参数，esi为快捷施法栏下标
005AC05F    | call wow.5ABBC0                      | 调用快捷栏技能
```

分析参数个数

```
005AC04F    | push 0                               |
005AC051    | push 3                               |
005AC053    | push edi                             |
005AC054    | call wow.84E0E0                      |
005AC059    | push eax                             |
005AC05A    | lea ecx,dword ptr ss:[ebp-8]         |
005AC05D    | push ecx                             |
005AC05E    | push esi                             | 
005AC05F    | call wow.5ABBC0                      | 
005AC064    | add esp,18                           |

函数内部看过了，ret无值，且是外平栈，分析函数外部
底下恢复栈空间的时候恢复了0x18=24个字节，为六个参数，进入5ABBC0函数后，有epb+10,有三个参数，外部push了三个参数，猜测是三个参数
```

因此如果要调用快捷施法，则用__asm传入三个参数，再call 0x005ABBC0，则可以执行
```
void do_skills(int 下标)
{
	int index = 下标;
	char*eax1 = "LeftButton";
	int ecx1[2] = { 0,0 };
	UINT_PTR address = 0x005ABBC0;
	__asm
	{
		lea eax, eax1
		push eax
		lea ecx,ecx1
		push ecx
		mov esi,index
		push esi
		call address
		add esp,0x0C
	}
}
调用这个函数以释放技能
```

## 当前进度代码备份

```
// DLL.cpp: 实现文件
//

#include "pch.h"
#include "MFCLibrary.h"
#include "DLL.h"
#include "afxdialogex.h"
#include"Hook.h"
#include<windows.h>
#include<iostream>
#include"AsciiUnicodeUtf8.h"
// DLL 对话框

IMPLEMENT_DYNAMIC(DLL, CDialogEx)

DLL::DLL(CWnd* pParent /*=nullptr*/)
	: CDialogEx(IDD_DIALOG1, pParent)
{

}

DLL::~DLL()
{
}

void DLL::DoDataExchange(CDataExchange* pDX)
{
	CDialogEx::DoDataExchange(pDX);
}


BEGIN_MESSAGE_MAP(DLL, CDialogEx)
	ON_BN_CLICKED(IDC_BUTTON1, &DLL::OnBnClickedButton1)
	ON_BN_CLICKED(IDC_BUTTON2, &DLL::OnBnClickedButton2)
	ON_BN_CLICKED(IDC_BUTTON3, &DLL::OnBnClickedButton3)
	ON_BN_CLICKED(IDC_BUTTON4, &DLL::OnBnClickedButton4)
	ON_BN_CLICKED(IDC_BUTTON5, &DLL::OnBnClickedButton5)
	ON_BN_CLICKED(IDC_BUTTON6, &DLL::OnBnClickedButton6)
	ON_BN_CLICKED(IDC_BUTTON7, &DLL::OnBnClickedButton7)
END_MESSAGE_MAP()
DWORD RM(UINT_PTR address)
{
	__try
	{
		return *(DWORD*)address;
	}
	__except (1)
	{
		return 0;
	}
}



UINT_PTR get_array_address()
{
	//读取 [[[fs:[2C]+0]+8]+1C]
	DWORD fs2C = 0;
	__asm
	{
		mov eax, dword ptr fs : [0x2C]
		mov fs2C, eax
	}
	DWORD array_address = RM(RM(RM(fs2C + 0) + 8) + 0x1C);
	return array_address;
}

//[[[fs:[2c]+0]+8]+24] ==0x1F
DWORD get_array_number()
{
	//读取 [[[fs:[2C]+0]+8]+24]
	DWORD fs2C = 0;
	__asm
	{
		mov eax, dword ptr fs : [0x2C]
		mov fs2C, eax
	}
	DWORD number = RM(RM(RM(fs2C + 0) + 8) + 0x24);
	return number;
}

// get_object  [2C1DDFF0+i*0x0C+8]   
UINT_PTR get_object(int i) //0..31 0..1F
{
	// [get_array_address+i*0x0C+8]   
	UINT_PTR array_address = get_array_address();//[[[fs:[2C]+0]+8]+1C]
	return RM(array_address + i * 0x0C + 8);
}

//print_message
void print_message(UINT_PTR object)
{

	UINT32 vftable = RM(object + 0);
	if (vftable == 0) return; //如果object是 空object 直接返回

	UINT32 ID1 = RM(object + 0x30);
	UINT32 ID2 = RM(object + 0x34);
	//[[怪object+964]+5c] //怪物名字
	char* utf8name = (char*)RM(RM(object + 0x964) + 0x5C);
	if (utf8name == NULL) return; //如果object是 空object 直接返回
	char char_name[256] = { 0 };
	utf8ToAscii(utf8name, char_name);
	printf("vftable=%X ID1=%X ID2=%X 名字=%s\n", vftable, ID1, ID2, char_name);
}

//遍历链表

void 遍历链表(UINT_PTR object)
{

}


//遍历数组
void bianli()
{
	//0..1F 0..get_array_number()
	int number = get_array_number();
	printf("遍历object数组 number=%d\n", number);
	for (int i = 0; i < number; i++)
	{
		UINT_PTR object = get_object(i);

		print_message(object);

		遍历链表(object);
	}

}
void do_skills(int 下标)
{
	int index = 下标;
	char*eax1 = "LeftButton";
	int ecx1[2] = { 0,0 };
	UINT_PTR address = 0x005ABBC0;
	__asm
	{
		lea eax, eax1
		push eax
		lea ecx,ecx1
		push ecx
		mov esi,index
		push esi
		call address
		add esp,0x0C
	}
}

VOID CALLBACK do_skill(HWND h, UINT arg2, UINT_PTR arg3_id, DWORD time)
{
	KillTimer(h, arg3_id);
	do_skills(0);
}
VOID CALLBACK main_ergodic_array(HWND h, UINT arg2, UINT_PTR arg3_id, DWORD time)
{
	KillTimer(h, arg3_id);
	bianli();
}
VOID CALLBACK timer(HWND h, UINT i, UINT_PTR n, DWORD d)
{
	DWORD RM(UINT_PTR address);
	const char*param1 = "player";
	UINT_PTR a;
	UINT_PTR address = 0x60C1F0;
	KillTimer(h, n);
	char buff[100];
	__asm
	{
		push param1
		call address
		add ebp, 4
		mov a, eax
	}
	//printf("a=%p,a+D0=%p,[a+D0]=%p,", a,a+0x000000D0,RM(a + 0x000000D0),RM(RM(a+0x000000D0)+ 0x00000174));
	printf("姓名%s\n力量=%d\n敏捷=%d\n耐力=%d\n智力=%d\n精神=%d\n护甲值=%d\n",
		(char *)0xC79D18,
		RM(RM(a + 0x000000D0) + 0x00000138),
		RM(RM(a + 0x000000D0) + 0x0000013C),
		RM(RM(a + 0x000000D0) + 0x00000140),
		RM(RM(a + 0x000000D0) + 0x00000144),
		RM(RM(a + 0x000000D0) + 0x00000148),
		RM(RM(a + 0x000000D0) + 0x00000174)
	);
	
};

void DLL::OnBnClickedButton1()
{
	 //TODO: 在此添加控件通知处理程序代码
	HWND hProcess = FindWindowA(NULL, "魔兽世界");

	::SetTimer(hProcess,1,1,timer);
}


void DLL::OnBnClickedButton2()
{
	// TODO: 在此添加控件通知处理程序代码
	AllocConsole();
	FILE *pFile=NULL;
	errno_t iret = freopen_s(&pFile,"CONOUT$", "w", stdout);
}


void DLL::OnBnClickedButton3()
{
	FreeConsole();
}


void DLL::OnBnClickedButton4()
{

	HWND hProcess = FindWindowA("GxWindowClassD3d", "魔兽世界");
	//printf("游戏窗口句柄=%p 行号=%d \r\n", 游戏窗口句柄, __LINE__);
	::SetTimer(hProcess, 10086, 1, main_ergodic_array); //#inclue<windows.h>
}

void DLL::OnBnClickedButton5()
{
	// TODO: 在此添加控件通知处理程序代码
	HWND hProcess = FindWindowA("GxWindowClassD3d", "魔兽世界");
	::SetTimer(hProcess, 10086, 1, do_skill); //#inclue<windows.h>
}

void 主线测试3()
{
	do_skills(2);
}

void DLL::OnBnClickedButton6()
{
	// TODO: 在此添加控件通知处理程序代码
	主线调用((UINT_PTR)主线测试3);
}


void DLL::OnBnClickedButton7()
{
	// TODO: 在此添加控件通知处理程序代码
	带多个参数的主线调用((UINT_PTR)主线测试3, 1);
}


HOOK文件

#include"pch.h"
#include<windows.h>
UINT_PTR 句柄基址 = 0xD41620;
UINT_PTR 原窗口过程 = NULL;
DWORD RM1(UINT_PTR address)
{
	__try
	{
		return *(DWORD*)address;
	}
	__except (1)
	{
		return 0;
	}
}

HWND 获取窗口句柄()
{
	return (HWND)RM1(0xD41620);
}

LRESULT 新的窗口过程(
	HWND hwnd, UINT uMsg, WPARAM wParam, LPARAM lParam
)
{
	UINT_PTR *参数数组 = (UINT_PTR*)lParam;
	switch (uMsg)
	{
	case WM_USER+128:
		__asm call lParam
		break;
	case WM_USER + 136:
		__asm
		{
			mov eax,参数数组
			mov ecx, dword ptr[eax + 7 * 4]
			push dword ptr[eax + 6 * 4]
			push dword ptr[eax + 5 * 4]
			push dword ptr[eax + 4 * 4]
			push dword ptr[eax + 3 * 4]
			push dword ptr[eax + 2 * 4]
			push dword ptr[eax + 1 * 4]
			call dword ptr[eax + 0 * 4]
			add esp,0x18
		}
		break;
	default:
		break;
	}
	return (CallWindowProcA((WNDPROC)原窗口过程, hwnd, uMsg,wParam,lParam));
}

void 挂接主线程()
{
	if (原窗口过程) return;
	//SendMessageA()
	HWND h = 获取窗口句柄(); //FindWindow	
	原窗口过程 = SetWindowLongPtrA(h, -4, (LONG)新的窗口过程);
}
void 卸载主线程()
{
	//取得游戏窗口句柄
	if (原窗口过程 == 0) return;
	//SendMessageA()
	HWND h = 获取窗口句柄(); //FindWindow	
	SetWindowLongPtrA(h, -4, (LONG)原窗口过程);
	原窗口过程 = 0;
}

void 主线调用(UINT_PTR call地址)
{
	static HWND h = 获取窗口句柄(); //FindWindow
	UINT_PTR 返回值 = SendMessageA(h, WM_USER + 128, 0, call地址); //SetWindowTextA
}

void 带多个参数的主线调用(UINT_PTR param1, UINT_PTR param2, UINT_PTR param3, UINT_PTR param4, UINT_PTR param5, UINT_PTR param6, UINT_PTR param7)
{
	static HWND h = 获取窗口句柄(); //FindWindow
	UINT_PTR 参数数组[8] = { param1, param2,param3,param4,param5,param6,param7 };
	UINT_PTR 返回值 = SendMessageA(h, WM_USER + 136, 0, (LPARAM)参数数组); //SetWindowTextA
}




// MFCLibrary.cpp: 定义 DLL 的初始化例程。
//

#include "pch.h"
#include "framework.h"
#include "MFCLibrary.h"
#include"DLL.h"
#include<Windows.h>
#ifdef _DEBUG
#define new DEBUG_NEW
#endif

//
//TODO:  如果此 DLL 相对于 MFC DLL 是动态链接的，
//		则从此 DLL 导出的任何调入
//		MFC 的函数必须将 AFX_MANAGE_STATE 宏添加到
//		该函数的最前面。
//
//		例如: 
//
//		extern "C" BOOL PASCAL EXPORT ExportedFunction()
//		{
//			AFX_MANAGE_STATE(AfxGetStaticModuleState());
//			// 此处为普通函数体
//		}
//
//		此宏先于任何 MFC 调用
//		出现在每个函数中十分重要。  这意味着
//		它必须作为以下项中的第一个语句:
//		出现，甚至先于所有对象变量声明，
//		这是因为它们的构造函数可能生成 MFC
//		DLL 调用。
//
//		有关其他详细信息，
//		请参阅 MFC 技术说明 33 和 58。
//

// CMFCLibraryApp

BEGIN_MESSAGE_MAP(CMFCLibraryApp, CWinApp)
END_MESSAGE_MAP()


// CMFCLibraryApp 构造

CMFCLibraryApp::CMFCLibraryApp()
{
	// TODO:  在此处添加构造代码，
	// 将所有重要的初始化放置在 InitInstance 中
}


// 唯一的 CMFCLibraryApp 对象

CMFCLibraryApp theApp;


// CMFCLibraryApp 初始化
DWORD WINAPI THEC()
{
	AFX_MANAGE_STATE(AfxGetStaticModuleState());
	DLL dll;
	挂接主线程();
	dll.DoModal();
	卸载主线程();
	return TRUE;
}
BOOL CMFCLibraryApp::InitInstance()
{
	CWinApp::InitInstance();
	::CreateThread(NULL, NULL, (LPTHREAD_START_ROUTINE)THEC, NULL, NULL, NULL);
	return TRUE;
}

```



## 分析怪物坐标

分析前提条件，一般情况下，怪物的坐标都是 怪物对象+偏移值，所以在程序中，找到怪物对象，在内存空间里找到疑似坐标的值
用之前写好的代码，输出遍历到的怪物对象的地址，进入xdbg查看，用浮点数查看内存
![image-20220810144703624](C:\Users\ROOT\AppData\Roaming\Typora\typora-user-images\image-20220810144703624.png)
在众多数据中 +798这个位置最像坐标了，就决定是他了

```
在遍历怪物数组的的代码中加上
float * xyz = (float *)RM(object + 0x798);

printf("vftable=%X 对象=%X ID1=%X ID2=%X 坐标（%lf,%lf,%lf）名字=%s\n", vftable, object, ID1, ID2,xyz[0],xyz[1],xyz[2], char_name);
```

即可



## 分析选中的怪物

分析前提：游戏设计中，一般选中怪物后，将怪物的id或者对象放到一个地址上，当没放值的时候为0，放值的时候大于0，和技能栏有些类似，先从四字节开始测试，不行再上八字节
分析出两个结果
![image-20220811133415966](C:\Users\ROOT\AppData\Roaming\Typora\typora-user-images\image-20220811133415966.png)
发现是分析怪物对象时的 ID1 和 ID2
找出是什么改写了此地址 00524F38 
进入xdbg调试

```
00524BF0 <wow.sub_524BF0>  | push ebp                             | 函数头
00524BF1                   | mov ebp,esp                          |
00524BF3                   | sub esp,2AC                          |
00524BF9                   | push ebx                             |
00524BFA                   | mov ebx,dword ptr ss:[ebp+8]         |
00524BFD                   | push esi                             |
00524BFE                   | mov esi,dword ptr ss:[ebp+C]         |
00524C01                   | mov eax,ebx                          |
00524C03                   | or eax,esi                           |
00524C05                   | jne wow.524C55                       |
00524C07                   | mov ecx,dword ptr ds:[BD07B4]        |
00524C0D                   | mov dword ptr ds:[BD08CC],eax        |
00524C12                   | mov eax,dword ptr ds:[BD07B0]        |
00524C17                   | mov edx,eax                          |
00524C19                   | or edx,ecx                           |
00524C1B                   | je wow.524CF2                        |
00524C21                   | push 1                               |
00524C23                   | push ecx                             |
00524C24                   | push eax                             |
00524C25                   | mov dword ptr ds:[BD07B8],eax        |
00524C2A                   | mov dword ptr ds:[BD07BC],ecx        |
00524C30                   | call <wow.sub_5241B0>                |
00524C35                   | add esp,C                            |
00524C38                   | call <wow.sub_7FE130>                |
00524C3D                   | test eax,eax                         |
00524C3F                   | je wow.524CF2                        |
00524C45                   | push 1                               |
00524C47                   | call <wow.sub_807560>                |
00524C4C                   | add esp,4                            |
00524C4F                   | pop esi                              |
00524C50                   | pop ebx                              |
00524C51                   | mov esp,ebp                          |
00524C53                   | pop ebp                              |
00524C54                   | ret                                  |
00524C55                   | call <wow.sub_4D3730>                |
00524C5A                   | test eax,eax                         |
00524C5C                   | je wow.524FA4                        |
00524C62                   | cmp byte ptr ds:[BD0790],0           |
00524C69                   | jne wow.524FA4                       |
00524C6F                   | cmp dword ptr ds:[D4139C],0          |
00524C76                   | je wow.524C8A                        |
00524C78                   | push 0                               |
00524C7A                   | push 0                               |
00524C7C                   | call <wow.sub_513530>                |
00524C81                   | add esp,8                            |
00524C84                   | pop esi                              |
00524C85                   | pop ebx                              |
00524C86                   | mov esp,ebp                          |
00524C88                   | pop ebp                              |
00524C89                   | ret                                  |
00524C8A                   | push edi                             |
00524C8B                   | call <wow.sub_4D3790>                |
00524C90                   | push A0                              |
00524C95                   | push wow.9F2340                      | 9F2340:"d:\\BuildServer\\WoW\\1\\work\\WoW-code\\branches\\wow-patch-3_3_5_A-BNet\\WoW\\Source\\Object/ObjectClient/Player_C.h"
00524C9A                   | push 10                              |
00524C9C                   | push edx                             |
00524C9D                   | push eax                             |
00524C9E                   | call <wow.sub_4D4DB0>                |
00524CA3                   | mov edi,eax                          |
00524CA5                   | add esp,14                           |
00524CA8                   | test edi,edi                         |
00524CAA                   | mov dword ptr ss:[ebp-4],edi         |
00524CAD                   | je wow.524CBD                        |
00524CAF                   | mov eax,dword ptr ds:[edi+D0]        |
00524CB5                   | mov ecx,dword ptr ds:[eax+18]        |
00524CB8                   | or ecx,dword ptr ds:[eax+1C]         |
00524CBB                   | jne wow.524CF1                       |
00524CBD                   | push 2CFD                            |
00524CC2                   | push wow.9FF09C                      | 9FF09C:".\\GameUI.cpp"
00524CC7                   | push 1                               |
00524CC9                   | push esi                             |
00524CCA                   | push ebx                             |
00524CCB                   | call <wow.sub_4D4DB0>                |
00524CD0                   | mov esi,eax                          |
00524CD2                   | add esp,14                           |
00524CD5                   | test esi,esi                         |
00524CD7                   | je wow.524ED2                        |
00524CDD                   | call <wow.sub_7FD620>                |
00524CE2                   | test al,al                           |
00524CE4                   | je wow.524CF8                        |
00524CE6                   | push 0                               |
00524CE8                   | push esi                             |
00524CE9                   | call <wow.sub_80BC80>                |
00524CEE                   | add esp,8                            |
00524CF1                   | pop edi                              |
00524CF2                   | pop esi                              |
00524CF3                   | pop ebx                              |
00524CF4                   | mov esp,ebp                          |
00524CF6                   | pop ebp                              |
00524CF7                   | ret                                  |
00524CF8                   | mov edx,dword ptr ds:[esi]           |
00524CFA                   | mov eax,dword ptr ds:[edx+A8]        |
00524D00                   | mov ecx,esi                          |
00524D02                   | call eax                             |
00524D04                   | test eax,eax                         |
00524D06                   | je wow.524CF1                        |
00524D08                   | cmp ebx,dword ptr ds:[BD07B0]        |
00524D0E                   | jne wow.524D1B                       |
00524D10                   | mov ecx,dword ptr ss:[ebp+C]         |
00524D13                   | cmp ecx,dword ptr ds:[BD07B4]        |
00524D19                   | je wow.524CF1                        |
00524D1B                   | cmp dword ptr ds:[AC80A8],0          |
00524D22                   | jne wow.524D33                       |
00524D24                   | mov eax,dword ptr ds:[BD09DC]        |
00524D29                   | test eax,eax                         |
00524D2B                   | je wow.524D3C                        |
00524D2D                   | cmp dword ptr ds:[eax+30],0          |
00524D31                   | je wow.524D3C                        |
00524D33                   | push 0                               |
00524D35                   | mov ecx,esi                          |
00524D37                   | call <wow.sub_743C70>                |
00524D3C                   | mov edx,dword ptr ds:[esi+8]         |
00524D3F                   | mov eax,dword ptr ds:[edx+8]         |
00524D42                   | shr eax,3                            |
00524D45                   | test al,1                            |
00524D47                   | je wow.524EFC                        |
00524D4D                   | mov ecx,dword ptr ds:[esi+B0]        |
00524D53                   | push ecx                             |
00524D54                   | call <wow.sub_7E50F0>                |
00524D59                   | add esp,4                            |
00524D5C                   | push 1000                            |
00524D61                   | mov ecx,esi                          |
00524D63                   | call <wow.sub_7158C0>                |
00524D68                   | lea ecx,dword ptr ss:[ebp-2AC]       |
00524D6E                   | call <wow.sub_8B7DA0>                |
00524D73                   | mov eax,dword ptr ds:[esi+A6C]       |
00524D79                   | test eax,eax                         |
00524D7B                   | je wow.524D93                        |
00524D7D                   | lea edx,dword ptr ss:[ebp-2AC]       |
00524D83                   | push edx                             |
00524D84                   | push eax                             |
00524D85                   | mov ecx,wow.AD49D0                   |
00524D8A                   | call <wow.sub_4CFD20>                |
00524D8F                   | test eax,eax                         |
00524D91                   | jne wow.524DB3                       |
00524D93                   | mov eax,dword ptr ds:[esi+A80]       |
00524D99                   | test eax,eax                         |
00524D9B                   | je wow.524DC1                        |
00524D9D                   | lea ecx,dword ptr ss:[ebp-2AC]       |
00524DA3                   | push ecx                             |
00524DA4                   | push eax                             |
00524DA5                   | mov ecx,wow.AD49D0                   |
00524DAA                   | call <wow.sub_4CFD20>                |
00524DAF                   | test eax,eax                         |
00524DB1                   | je wow.524DC1                        |
00524DB3                   | lea edx,dword ptr ss:[ebp-2AC]       |
00524DB9                   | push edx                             |
00524DBA                   | mov ecx,esi                          |
00524DBC                   | call wow.7262E0                      |
00524DC1                   | call <wow.sub_86AE20>                |
00524DC6                   | push eax                             |
00524DC7                   | mov ecx,esi                          |
00524DC9                   | call <wow.sub_720E50>                |
00524DCE                   | test edi,edi                         |
00524DD0                   | je wow.524EC5                        |
00524DD6                   | push esi                             |
00524DD7                   | mov ecx,edi                          |
00524DD9                   | call <wow.sub_729A70>                |
00524DDE                   | test al,al                           |
00524DE0                   | je wow.524DF2                        |
00524DE2                   | mov eax,dword ptr ss:[ebp+C]         |
00524DE5                   | mov dword ptr ds:[BD07C0],ebx        |
00524DEB                   | mov dword ptr ds:[BD07C4],eax        |
00524DF0                   | jmp wow.524E0F                       |
00524DF2                   | push 0                               |
00524DF4                   | push esi                             |
00524DF5                   | mov ecx,edi                          |
00524DF7                   | call <wow.sub_7293D0>                |
00524DFC                   | test al,al                           |
00524DFE                   | je wow.524E0F                        |
00524E00                   | mov ecx,dword ptr ss:[ebp+C]         |
00524E03                   | mov dword ptr ds:[BD07C8],ebx        |
00524E09                   | mov dword ptr ds:[BD07CC],ecx        |
00524E0F                   | mov eax,dword ptr ds:[esi+8]         |
00524E12                   | mov edx,dword ptr ds:[eax+8]         |
00524E15                   | shr edx,4                            |
00524E18                   | test dl,1                            |
00524E1B                   | je wow.524E5D                        |
00524E1D                   | mov edi,dword ptr ds:[eax]           |
00524E1F                   | mov ebx,dword ptr ds:[eax+4]         |
00524E22                   | call <wow.sub_4D3790>                |
00524E27                   | cmp edi,eax                          |
00524E29                   | jne wow.524E2F                       |
00524E2B                   | cmp ebx,edx                          |
00524E2D                   | je wow.524E5A                        |
00524E2F                   | push 12                              |
00524E31                   | call <wow.sub_522270>                |
00524E36                   | add esp,4                            |
00524E39                   | test al,al                           |
00524E3B                   | je wow.524E5A                        |
00524E3D                   | push 12                              |
00524E3F                   | call <wow.sub_530840>                |
00524E44                   | mov edi,dword ptr ss:[ebp-4]         |
00524E47                   | add esp,4                            |
00524E4A                   | lea ecx,dword ptr ss:[ebp-2AC]       |
00524E50                   | call <wow.sub_5EEB70>                |
00524E55                   | jmp wow.524EFC                       |
00524E5A                   | mov edi,dword ptr ss:[ebp-4]         |
00524E5D                   | mov eax,dword ptr ds:[esi+8]         |
00524E60                   | mov ecx,dword ptr ds:[eax+8]         |
00524E63                   | shr ecx,4                            |
00524E66                   | test cl,1                            |
00524E69                   | je wow.524E8A                        |
00524E6B                   | push esi                             |
00524E6C                   | mov ecx,edi                          |
00524E6E                   | call <wow.sub_729B30>                |
00524E73                   | test al,al                           |
00524E75                   | je wow.524E8A                        |
00524E77                   | mov edx,dword ptr ds:[edi+D0]        |
00524E7D                   | cmp dword ptr ds:[edx+C0],5          |
00524E84                   | jl wow.524E8A                        |
00524E86                   | push 11                              |
00524E88                   | jmp wow.524EBD                       |
00524E8A                   | push esi                             |
00524E8B                   | mov ecx,edi                          |
00524E8D                   | call <wow.sub_729740>                |
00524E92                   | test al,al                           |
00524E94                   | je wow.524E9A                        |
00524E96                   | push 4                               |
00524E98                   | jmp wow.524EBD                       |
00524E9A                   | mov eax,dword ptr ds:[esi+D0]        |
00524EA0                   | mov ecx,dword ptr ds:[eax+130]       |
00524EA6                   | shr ecx,D                            |
00524EA9                   | test cl,1                            |
00524EAC                   | je wow.524EB2                        |
00524EAE                   | push 22                              |
00524EB0                   | jmp wow.524EBD                       |
00524EB2                   | cmp dword ptr ds:[esi+90],1          |
00524EB9                   | jne wow.524EC5                       |
00524EBB                   | push 2A                              |
00524EBD                   | call <wow.sub_530840>                |
00524EC2                   | add esp,4                            |
00524EC5                   | lea ecx,dword ptr ss:[ebp-2AC]       |
00524ECB                   | call <wow.sub_5EEB70>                |
00524ED0                   | jmp wow.524EFC                       |
00524ED2                   | cmp ebx,dword ptr ds:[BD07B0]        |
00524ED8                   | jne wow.524EE9                       |
00524EDA                   | mov edx,dword ptr ss:[ebp+C]         |
00524EDD                   | cmp edx,dword ptr ds:[BD07B4]        |
00524EE3                   | je wow.524CF1                        |
00524EE9                   | push 0                               |
00524EEB                   | push 0                               |
00524EED                   | push 0                               |
00524EEF                   | push wow.A02D68                      | A02D68:"igCharacterSelect"
00524EF4                   | call <wow.sub_4C74A0>                |
00524EF9                   | add esp,10                           |
00524EFC                   | test edi,edi                         |
00524EFE                   | je wow.524F0F                        |
00524F00                   | mov ecx,edi                          |
00524F02                   | call <wow.sub_5140E0>                |
00524F07                   | test eax,eax                         |
00524F09                   | je wow.524F0F                        |
00524F0B                   | mov bl,1                             |
00524F0D                   | jmp wow.524F11                       |
00524F0F                   | xor bl,bl                            |
00524F11                   | mov eax,dword ptr ds:[BD07B4]        |
00524F16                   | mov ecx,dword ptr ds:[BD07B0]        |
00524F1C                   | push 0                               |
00524F1E                   | push eax                             |
00524F1F                   | push ecx                             |
00524F20                   | mov dword ptr ds:[BD07B8],ecx        |
00524F26                   | mov dword ptr ds:[BD07BC],eax        |
00524F2B                   | call <wow.sub_5241B0>                |
00524F30                   | mov ecx,dword ptr ss:[ebp+C]         |
00524F33                   | mov eax,dword ptr ss:[ebp+8]         |
00524F36                   | push ecx                             |
00524F37                   | push eax                             |
00524F38                   | mov dword ptr ds:[BD07B0],eax        | ID1
00524F3D                   | mov dword ptr ds:[BD07B4],ecx        | ID2
```

一层层返回找到正确的选中call，判断正确call的依据：下断点，在游戏中乱点不会莫名其妙的断下，当选中人物的时候立刻断下
```
004F798B <wow.sub_4F798B>  | mov ecx,dword ptr ds:[esi+2E0]       |
004F7991                   | mov edx,dword ptr ds:[esi+2E4]       |
004F7997                   | mov eax,dword ptr ss:[ebp+8]         |
004F799A                   | mov dword ptr ss:[ebp-10],ecx        |
004F799D                   | lea ecx,dword ptr ss:[ebp-10]        |
004F79A0                   | push ecx                             |
004F79A1                   | mov dword ptr ss:[ebp-C],edx         |
004F79A4                   | mov dword ptr ss:[ebp-8],eax         |
004F79A7                   | call <wow.sub_527870>                | 正确的选中call
004F79AC                   | add esp,4                            |
004F79AF                   | pop esi                              | esi:&"`疧"
004F79B0                   | mov esp,ebp                          |
004F79B2                   | pop ebp                              |
004F79B3                   | ret 4                                |
```

分析传入的参数
根据上面汇编，edx，eax分别对应 id1，id2，还传入了一个1，看三个变量的地址[ebp-10]，[ebp-C]，[ebp-8]，是连续的，则ecx可能是数组的首地址，变量为一个数组传入
\[ebp - C\]  = ID2
ecx = ID1
\[ebp -8\] = 1
代码测试

```
void choice_object()
{
	UINT param1[] = { 0x3A01F5FB ,0xF130006F ,1 };
	UINT_PTR address = 0x00527870;
	__asm
	{
		lea ecx, param1
		push ecx
		call address
		add esp, 4
	}
}
```

执行后成功选中对象



## 分析技能call

### 方法1

因为是网络游戏，可以从发包的角度去搜索，在xdbg中转到 send 地方，下断点

\[\[esp+8\]+0\] = 包的内容

\[esp+0c\] = 包的长度

根据包的内容编辑条件断点，看一个数据后，\[\[esp+8\]+0\] ！= 已经看到的数据 ，一次次过滤掉不需要的包，最后游戏不随便断下，而一点技能就断下时，则找到正确的包

### 方法二

像找快捷栏使用call一样，一层层追，追到一个call有发包内容（send）

### 方法三

使用技能快捷栏使用call，打上断点，在释放技能断下后，在send位置下断点，此时send下一个发送的包很有可能就是需要的包，此时send的包信息中，一般找不到技能的id或者表示技能的值，因为技能的id被加密过了，一层层向上查，查到技能id被加密前的发包的call，继续向上的依据就是栈空间里没有技能的id

### 方法四

在放技能断下时，用ce搜技能的地址，向下追，不停下断点和代码调试，调试到正确的call

分析：

 先在调用技能处下断点，断下，搜索send函数，同样下断点![image-20220828154221202](C:\Users\ROOT\AppData\Roaming\Typora\typora-user-images\image-20220828154221202.png)

此时技能ID为c1a8

![image-20220828154948245](C:\Users\ROOT\AppData\Roaming\Typora\typora-user-images\image-20220828154948245.png)

在send处停下，此时已经是正确的包，但是此时包的内存是加密的，向上追未加密时的包

从堆空间返回上一层call

![image-20220828155319252](C:\Users\ROOT\AppData\Roaming\Typora\typora-user-images\image-20220828155319252.png)

向上找函数头

```
004675F0 <wow.sub_4675F0>  | push ebp                             |
004675F1                   | mov ebp,esp                          |
004675F3                   | sub esp,60                           |
004675F6                   | push ebx                             |
004675F7                   | push esi                             |
004675F8                   | push edi                             |
004675F9                   | mov edi,dword ptr ss:[ebp+8]         |
004675FC                   | mov ebx,dword ptr ds:[edi+10]        |
004675FF                   | push ebx                             |
00467600                   | lea eax,dword ptr ss:[ebp-8]         |
00467603                   | mov esi,ecx                          |
00467605                   | push eax                             |
00467606                   | mov ecx,edi                          |
00467608                   | call <wow.sub_47B6B0>                |
0046760D                   | mov eax,ebx                          |
0046760F                   | cdq                                  |
00467610                   | add dword ptr ds:[B38D10],eax        | 00B38D10:"y\""
00467616                   | lea ecx,dword ptr ds:[esi+108]       |
0046761C                   | mov dword ptr ss:[ebp-4],2           |
00467623                   | adc dword ptr ds:[B38D14],edx        |
00467629                   | mov dword ptr ss:[ebp-10],ecx        |
0046762C                   | call <wow.sub_774640>                |
00467631                   | test ebx,ebx                         |
00467633                   | jg wow.467641                        |
00467635                   | mov dword ptr ss:[ebp-4],2           |
0046763C                   | jmp wow.467971                       |
00467641                   | cmp dword ptr ds:[esi+10],5          |
00467645                   | jne wow.467971                       |
0046764B                   | cmp dword ptr ds:[B38D20],0          |
00467652                   | jne wow.467887                       |
00467658                   | mov eax,dword ptr ds:[esi+E8]        |
0046765E                   | test al,1                            |
00467660                   | jne wow.46766A                       |
00467662                   | test eax,eax                         |
00467664                   | jne wow.467887                       |
0046766A                   | mov edi,dword ptr ds:[edi+10]        |
0046766D                   | cmp edi,186A0                        |
00467673                   | jae wow.467735                       |
00467679                   | cmp dword ptr ss:[ebp+C],3           |
0046767D                   | mov byte ptr ss:[ebp+B],1            |
00467681                   | jl wow.467713                        |
00467687                   | mov eax,28                           | 28:'('
0046768C                   | call <wow.sub_40BB50>                |
00467691                   | mov edi,esp                          |
00467693                   | test edi,edi                         |
00467695                   | je wow.467749                        |
0046769B                   | mov eax,dword ptr ss:[ebp-8]         |
0046769E                   | xor ecx,ecx                          |
004676A0                   | cmp ebx,7FFF                         |
004676A6                   | setg cl                              |
004676A9                   | mov dword ptr ds:[edi],0             |
004676AF                   | mov dword ptr ds:[edi+4],0           |
004676B6                   | mov edx,ebx                          |
004676B8                   | add ecx,2                            |
004676BB                   | sub eax,ecx                          |
004676BD                   | cmp ebx,7FFF                         |
004676C3                   | mov dword ptr ds:[edi+8],eax         |
004676C6                   | jg wow.4676D2                        |
004676C8                   | sar edx,8                            |
004676CB                   | mov byte ptr ds:[eax],dl             |
004676CD                   | mov byte ptr ds:[eax+1],bl           |
004676D0                   | jmp wow.4676E5                       |
004676D2                   | sar edx,10                           |
004676D5                   | or dl,80                             |
004676D8                   | mov byte ptr ds:[eax],dl             |
004676DA                   | mov edx,ebx                          |
004676DC                   | sar edx,8                            |
004676DF                   | mov byte ptr ds:[eax+1],dl           |
004676E2                   | mov byte ptr ds:[eax+2],bl           |
004676E5                   | xor edx,edx                          |
004676E7                   | lea eax,dword ptr ds:[ecx+ebx]       |
004676EA                   | cmp eax,8                            |
004676ED                   | mov dword ptr ds:[edi+10],edx        |
004676F0                   | mov dword ptr ds:[edi+C],eax         |
004676F3                   | mov dword ptr ds:[edi+14],ebx        |
004676F6                   | mov dword ptr ds:[edi+24],edx        |
004676F9                   | jbe wow.467700                       |
004676FB                   | mov eax,8                            |
00467700                   | push eax                             |
00467701                   | mov eax,dword ptr ds:[edi+8]         |
00467704                   | push eax                             |
00467705                   | lea ecx,dword ptr ds:[edi+18]        |
00467708                   | push ecx                             |
00467709                   | call wow.40CB10                      |
0046770E                   | add esp,C                            |
00467711                   | jmp wow.467749                       |
00467713                   | lea eax,dword ptr ds:[edi+2B]        |
00467716                   | call <wow.sub_40CA10>                |
0046771B                   | mov edi,esp                          |
0046771D                   | test edi,edi                         |
0046771F                   | je wow.467749                        |
00467721                   | mov eax,dword ptr ss:[ebp-8]         |
00467724                   | push 0                               |
00467726                   | lea edx,dword ptr ds:[edi+28]        |
00467729                   | push edx                             |
0046772A                   | push ebx                             |
0046772B                   | push eax                             |
0046772C                   | mov ecx,edi                          |
0046772E                   | call <wow.sub_467190>                |
00467733                   | jmp wow.467749                       |
00467735                   | mov ecx,dword ptr ss:[ebp-8]         |
00467738                   | push 0                               |
0046773A                   | push ebx                             |
0046773B                   | push ecx                             |
0046773C                   | mov ecx,esi                          |
0046773E                   | mov byte ptr ss:[ebp+B],0            |
00467742                   | call <wow.sub_467540>                |
00467747                   | mov edi,eax                          |
00467749                   | cmp byte ptr ds:[esi+374],0          |
00467750                   | je wow.467773                        |
00467752                   | movzx eax,byte ptr ds:[esi+375]      |
00467759                   | sub eax,dword ptr ds:[edi+14]        |
0046775C                   | mov ecx,dword ptr ds:[edi+C]         |
0046775F                   | add eax,ecx                          |
00467761                   | cmp eax,ecx                          |
00467763                   | jbe wow.467767                       |
00467765                   | mov eax,ecx                          |
00467767                   | mov edx,dword ptr ds:[edi+8]         |
0046776A                   | push eax                             |
0046776B                   | push edx                             |
0046776C                   | mov ecx,esi                          |
0046776E                   | call <wow.sub_4665B0>                |
00467773                   | mov eax,dword ptr ds:[edi+C]         |
00467776                   | mov ecx,dword ptr ds:[edi+8]         |
00467779                   | mov edx,dword ptr ds:[esi+4]         |
0046777C                   | push 0                               |
0046777E                   | push eax                             |
0046777F                   | push ecx                             |
00467780                   | push edx                             |
00467781                   | call dword ptr ds:[<&send>]          | send 函数
00467787                   | cmp eax,dword ptr ds:[edi+C]         |
```

可以看到

```
004675F1                   | mov ebp,esp                          |
004675F3                   | sub esp,60    
```

平栈了以后提升了60的esp ， 开辟了0x60个栈空间，到send处push了21个参数，则起码在  此处栈空间+0x60+（十进制）21开外,处才能找到此函数的 “返回到”

 ![image-20220828161113719](C:\Users\ROOT\AppData\Roaming\Typora\typora-user-images\image-20220828161113719.png)

挨个点进去看，得到在C0处返回的是正确的

![image-20220828161209546](C:\Users\ROOT\AppData\Roaming\Typora\typora-user-images\image-20220828161209546.png)

```
00632BAC                   | call <wow.sub_47B280>                |
00632BB1                   | mov edx,dword ptr ds:[edi]           |
00632BB3                   | mov eax,dword ptr ds:[edx+1C]        |
00632BB6                   | mov ecx,edi                          |
00632BB8                   | call eax                             |
00632BBA                   | pop edi                              |
00632BBB                   | pop ebx                              |
00632BBC                   | pop esi                              |
00632BBD                   | pop ebp                              |
00632BBE                   | ret 4                                |
00632BC1                   | mov ecx,dword ptr ds:[esi+2E38]      |
00632BC7                   | push edi                             |
00632BC8                   | call <wow.sub_4675F0>                | send2
00632BCD                   | mov eax,dword ptr ds:[esi+2E38]      |
00632BD3                   | add dword ptr ds:[C5D628],ebx        |
00632BD9                   | add dword ptr ds:[C5D62C],1          |
00632BE0                   | add dword ptr ds:[esi+2E9C],ebx      |
00632BE6                   | cmp byte ptr ds:[eax+374],0          |
00632BED                   | jne wow.632BFB                       |
00632BEF                   | push 0                               |
00632BF1                   | push 0                               |
00632BF3                   | push eax                             |
00632BF4                   | mov ecx,esi                          |
00632BF6                   | call <wow.sub_632690>                |
```

c![image-20220828161622168](C:\Users\ROOT\AppData\Roaming\Typora\typora-user-images\image-20220828161622168.png)

此时栈空间里没有技能ID，再往上找

算栈针
```
00632BBA                   | pop edi                              |
00632BBB                   | pop ebx                              |
00632BBC                   | pop esi                              |
00632BBD                   | pop ebp                              |
00632BBE                   | ret 4                                |
00632BC1                   | mov ecx,dword ptr ds:[esi+2E38]      |
00632BC7                   | push edi                             |
```

pop了四个四字节，ret了一个4字节，在call的时候压了一个四字节，所以栈针应当在此栈空间+0x1C的位置

![image-20220828162523205](C:\Users\ROOT\AppData\Roaming\Typora\typora-user-images\image-20220828162523205.png)

返回后得到send3

![image-20220828162627388](C:\Users\ROOT\AppData\Roaming\Typora\typora-user-images\image-20220828162627388.png)

```
006B0B48                   | mov edx,dword ptr ds:[eax+70]        |
006B0B4B                   | jmp edx                              |
006B0B4D                   | int3                                 |
006B0B4E                   | int3                                 |
006B0B4F                   | int3                                 |
006B0B50 <wow.sub_6B0B50>  | push ebp                             |
006B0B51                   | mov ebp,esp                          |
006B0B53                   | mov ecx,dword ptr ds:[C79CF4]        |
006B0B59                   | test ecx,ecx                         |
006B0B5B                   | je wow.6B0B68                        |
006B0B5D                   | mov eax,dword ptr ss:[ebp+8]         |
006B0B60                   | push eax                             |
006B0B61                   | call <wow.sub_632B50>                | send3
006B0B66                   | pop ebp                              |
006B0B67                   | ret                                  |
006B0B68                   | push 0                               |
006B0B6A                   | push wow.9E14FF                      | 9E14FF:L"瀀牥f"
006B0B6F                   | push wow.9E14FF                      | 9E14FF:L"瀀牥f"
006B0B74                   | call <wow.sub_8889B0>                |
```

继续向上找

006B0B61                   | call <wow.sub_632B50>                | send3
006B0B66                   | pop ebp   

call的时候push了四字节，pop 了四字节，说明前面push了四字节，所以应当在八字节开外

![image-20220828163204168](C:\Users\ROOT\AppData\Roaming\Typora\typora-user-images\image-20220828163204168.png)

在+c出返回，得到send4，此时栈空间还是没有技能Id，继续向上找

![image-20220828211856318](C:\Users\ROOT\AppData\Roaming\Typora\typora-user-images\image-20220828211856318.png)

```
0080B4B2                              | 75 2F                    | jne wow.80B4E3                       |
0080B4B4                              | F685 4CFDFFFF 80         | test byte ptr ss:[ebp-2B4],80        |
0080B4BB                              | 74 26                    | je wow.80B4E3                        |
0080B4BD                              | E8 2E84BFFF              | call <wow.sub_4038F0>                |
0080B4C2                              | 85C0                     | test eax,eax                         | eax:&"协G"
0080B4C4                              | 74 0F                    | je wow.80B4D5                        |
0080B4C6                              | 8B88 600F0000            | mov ecx,dword ptr ds:[eax+F60]       | eax+F60:"臋z\r"
0080B4CC                              | 85C9                     | test ecx,ecx                         |
0080B4CE                              | 74 05                    | je wow.80B4D5                        |
0080B4D0                              | E8 CBCAF3FF              | call <wow.sub_747FA0>                |
0080B4D5                              | 8B0D AC76CD00            | mov ecx,dword ptr ds:[CD76AC]        |
0080B4DB                              | 51                       | push ecx                             |
0080B4DC                              | 8BCB                     | mov ecx,ebx                          | ebx:&"衳n"
0080B4DE                              | E8 2DF9F0FF              | call <wow.sub_71AE10>                |
0080B4E3                              | 8D55 E4                  | lea edx,dword ptr ss:[ebp-1C]        | [ebp-1C]:"协G"
0080B4E6                              | 52                       | push edx                             | edx:&"协G"
0080B4E7                              | C745 F8 00000000         | mov dword ptr ss:[ebp-8],0           |
0080B4EE                              | E8 5D56EAFF              | call <wow.sub_6B0B50>                | 

send4


0080B4F3                              | 83C4 04                  | add esp,4                            |
0080B4F6                              | C705 E4F4D300 00000000   | mov dword ptr ds:[D3F4E4],0          |
0080B500                              | E8 CBE0DEFF              | call <wow.sub_5F95D0>                |
0080B505                              | 8360 58 EF               | and dword ptr ds:[eax+58],FFFFFFEF   |
0080B509                              | 6A 00                    | push 0                               |
0080B50B                              | 8BC8                     | mov ecx,eax                          | eax:&"协G"
0080B50D                              | E8 7EF3DEFF              | call <wow.sub_5FA890>                |
0080B512                              | 8BCE                     | mov ecx,esi                          | esi:&"衳n"
0080B514                              | E8 3739CCFF              | call <wow.sub_4CEE50>                |
```

网上找函数头

```
0080AC90 <wow.sub_80AC90>             | push ebp                             |
0080AC91                              | mov ebp,esp                          |
0080AC93                              | sub esp,2E0                          |
0080AC99                              | push ebx                             | ebx:&"衳n"
0080AC9A                              | push esi                             | esi:&"衳n"
0080AC9B                              | push edi                             |
```

2E0+4（push ebp）+4(call xxxxxxxx) = 0x2E8 开外

找到send5

![image-20220828213315212](C:\Users\ROOT\AppData\Roaming\Typora\typora-user-images\image-20220828213315212.png)

```
0080C873                              | push edx                             |
0080C874                              | call <wow.sub_76F070>                |
0080C879                              | mov esi,dword ptr ds:[D3F4E0]        |
0080C87F                              | and esi,FFFFDFFF                     |
0080C885                              | add esp,10                           |
0080C888                              | mov byte ptr ds:[D3F4F0],0           |
0080C88F                              | or dword ptr ds:[ebx+28],2000        |
0080C896                              | mov dword ptr ds:[D3F4E0],esi        |
0080C89C                              | test esi,esi                         |
0080C89E                              | jne wow.80C8B4                       |
0080C8A0                              | push esi                             |
0080C8A1                              | mov eax,ebx                          |
0080C8A3                              | call <wow.sub_80AC90>                | send5
0080C8A8                              | add esp,4                            |
0080C8AB                              | pop edi                              | edi:&"衳n"
0080C8AC                              | pop esi                              |
0080C8AD                              | mov al,1                             |
0080C8AF                              | pop ebx                              |
0080C8B0                              | mov esp,ebp                          |
0080C8B2                              | pop ebp                              |
0080C8B3                              | ret                                  |
0080C8B4                              | test dword ptr ds:[edi+24],800       |
0080C8BB                              | mov esi,dword ptr ss:[ebp+10]        |
```

再查

![image-20220828221714086](C:\Users\ROOT\AppData\Roaming\Typora\typora-user-images\image-20220828221714086.png)

```
0080D70A                              | call <wow.sub_4C74A0>                |
0080D70F                              | add esp,10                           |
0080D712                              | mov ecx,dword ptr ss:[ebp+20]        |
0080D715                              | mov edx,dword ptr ss:[ebp+18]        |
0080D718                              | mov eax,dword ptr ss:[ebp+14]        |
0080D71B                              | push ecx                             |
0080D71C                              | push esi                             |
0080D71D                              | push edx                             |
0080D71E                              | push eax                             |
0080D71F                              | lea ecx,dword ptr ss:[ebp-2B8]       |
0080D725                              | push ecx                             |
0080D726                              | push edi                             | edi:&"衳n"
0080D727                              | call wow.80C790                      | send6
0080D72C                              | add esp,18                           |
0080D72F                              | test al,al                           |
0080D731                              | jne wow.80D8EF                       |
0080D737                              | mov ebx,dword ptr ss:[ebp+14]        |
0080D73A                              | cmp ebx,FFFFFFFE                     |
0080D73D                              | jne wow.80D771                       |
0080D73F                              | cmp dword ptr ss:[ebp+18],FFFFFFFF   |
0080D743                              | jne wow.80D771                       |
0080D745                              | push 0                               |
```

栈空间已经可以看到ID

 ![image-20220828221834496](C:\Users\ROOT\AppData\Roaming\Typora\typora-user-images\image-20220828221834496.png)

再找

![image-20220828221918181](C:\Users\ROOT\AppData\Roaming\Typora\typora-user-images\image-20220828221918181.png)

```
0080DB97                              | pop ebp                              |
0080DB98                              | ret                                  |
0080DB99                              | mov ecx,dword ptr ss:[ebp+14]        |
0080DB9C                              | mov edx,dword ptr ss:[ebp+10]        |
0080DB9F                              | mov eax,dword ptr ss:[ebp+C]         |
0080DBA2                              | push 0                               |
0080DBA4                              | push ecx                             |
0080DBA5                              | push edx                             |
0080DBA6                              | push eax                             |
0080DBA7                              | push edi                             | 技能ID
0080DBA8                              | call <wow.sub_80DA40>                | send7
0080DBAD                              | add esp,14                           |
0080DBB0                              | lea ecx,dword ptr ss:[ebp-2A8]       |
0080DBB6                              | call <wow.sub_5EEB70>                |
0080DBBB                              | pop edi                              |
0080DBBC                              | pop esi                              | esi:&"衳n"
0080DBBD                              | mov esp,ebp                          |
0080DBBF                              | pop ebp                              |
0080DBC0                              | ret                                  |
```

栈空间第一个就是技能ID

 ![image-20220828222100310](C:\Users\ROOT\AppData\Roaming\Typora\typora-user-images\image-20220828222100310.png)



已经有一个比较简明的call，并且有技能id，此处下断点，随便点也不会断下，只有在放技能才断下，

则技能call寻找完成

此时已经完成技能call的寻找

断下后分析call的参数

```
0080DBA2                              | push 0                               |
0080DBA4                              | push ecx                             |
0080DBA5                              | push edx                             |
0080DBA6                              | push eax                             |
0080DBA7                              | push edi                             | 技能ID
0080DBA8                              | call <wow.sub_80DA40>                | send7
```

发现ecx，edx，eax，edi全是0，则构造的时候push五个0再call



分析喊话call可以得到6b0b50是明文包的call，call 6b0b50，在xdbg中搜索常数，搜索6b0b50，则能搜出所有需要发明文包的函数，包括买东西，卖东西，使用物品,选择在所有命令上下断点，然后游戏中操作，看哪个断点断下则是哪个功能
